---
title: "Locating trees beyond the quadrat edge"
output: 
  rmarkdown::html_notebook:
    toc: true
    toc_depth: 6
    theme: united
---

Some trees may map beyond the edge of a quadrat. This document shows how to deal with those trees: How to know their status and how to locate them.

```{r setup, include=FALSE}
set.seed(1014)
options(digits = 3)

knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.align = "center",
  fig.show = "hold",
  out.width = "98%", 
  fig.width = 14, 
  fig.asp = 0.75
)
```

```{r}
library(dplyr)
library(fgeo)
```

```{r, include=FALSE}
raw <- sinharaja::sinh_vft

quad_spillover <- raw %>% 
  filter(Status == "dead") %>% 
  select(matches("qx|qy"), everything()) %>% 
  filter(any(QX > 20, QY > 20)) %>% 
  group_by(QuadratID) %>% 
  count(Tag, sort = TRUE) %>% 
  top(n, -1) %>% 
  pull(QuadratID)
```

```{r, include=FALSE}
vft_top1spillover <- filter(raw, QuadratID == quad_spillover)
xy <- mutate(vft_top1spillover, x = QX, y = QY)
vft <- xy %>% 
  select(QX, QY, Status, Tag, everything()) %>%
  arrange(desc(x), desc(y))

vft1 <-   dplyr::filter(vft, PlotID == 1)
vft_data <- top(vft1, CensusID, -1)

# Let's confirm that the data we `want` has only the last census.
unique(vft_data$CensusID)
# Great! This is what the data we `want` looks like.
```

The dataset we'll use is one quadrat from a ViewFullTable from Sinharaja. I chose this quadrat because it has a particularly high number of trees that map beyond the quadrat edge.

```{r}
vft_data
```

```{r}
# Showing only one map (page 3)
map_tag(vft_data)[[3]]
```

Notice above that some trees spillover beyond the quadrat edge (`QX` or `QY` greater than 20m). `map_tag()` will print a small caption giving the coordinates of the trees that spillover (if the caption is too long it will be truncated).

The problem with the map above is that it lacks information about the status of the trees that spillover because the status is encoded by the point symbol. To solve that problem we can add a suffix to the tree tag. To keep the maps as clean as possible, we can suffix only the few tags of the trees that are dead AND beyond the quadrat edge.

__1. Suffix dead trees beyond quadrat edge__

```{r}
suffixed <- suffix_edge_tag(
  x = vft_data,            # What data?
  .match = "dead",     # Trees of what status?
  suffix = ".d",       # What suffix to add?
  x_q = 20             # What is the limit beyond which we want to add a suffix?
)
suffixed
```

And now we map again.

```{r}
map_tag(suffixed)[[3]]
```

Notice `Tag = 073246.d` at `QX = 20.20` and `QY = 13.25`.

__2. Extend the quadrat edge__

Another way to help solve this problem is to move the quadrat edge a little beyond its limit.

```{r}
map_tag(suffixed, move_edge = 1)[[3]]
```

Now we can see the position of the tree 073246, and therefore we can see the symbol "x" indicating that it is dead.

__Suffix all dead trees__

If you want to suffix all dead trees, simply choose `x_q = 0`.

```{r}
suffix_all_dead <- suffix_edge_tag(
  x = vft_data,            # What data?
  .match = "dead",   # Trees of what status?
  suffix = ".d",       # What suffix to add?
  x_q = 0              # What is the limit beyond which we want to add a suffix?
)
```

Now notice that -- regardless of their position --all dead trees have the suffix ".d".

```{r}
filter(suffix_all_dead, Status == "dead")
```



