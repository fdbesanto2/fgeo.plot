---
title: "Dealing with edgy trees"
output: 
  rmarkdown::html_notebook:
    toc: true
    toc_depth: 6
    theme: united
---

```{r setup, include=FALSE}
set.seed(1014)
options(digits = 3)

knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  fig.align = "center",
  fig.show = "hold",
  out.width = "98%", 
  fig.width = 9.5, 
  fig.asp = 0.7
)
```

```{r}
library(dplyr)
library(fgeo)
```

```{r, include=FALSE}
raw <- sinharaja::sinh_vft

quad_spillover <- raw %>% 
  filter(Status == "dead") %>% 
  select(matches("qx|qy"), everything()) %>% 
  filter(any(QX > 20, QY > 20)) %>% 
  group_by(QuadratID) %>% 
  count(Tag, sort = TRUE) %>% 
  top(n, -1) %>% 
  pull(QuadratID)
```

```{r, include=FALSE}
vft_top1spillover <- filter(raw, QuadratID == quad_spillover)
xy <- mutate(vft_top1spillover, x = QX, y = QY)
vft <- xy %>% 
  select(QX, QY, Status, Tag, everything()) %>%
  arrange(desc(x), desc(y))
```

The dataset `vft` is a small subset of a ViewFullTable. Let's start by filtering the data to keep only those from the plot we want to work with.

```{r}
vft1 <-   dplyr::filter(vft, PlotID == 1)
```

Now the data has `R nrow(vft)` rows.

```{r}
nrow(vft1)
```

Notice that this dataset has data from multiple censuses.

```{r}
unique(vft1$CensusID)
```

Not all those data are relevant for a re-census. The trees we want to keep are those that are either alive or that appear dead in only one of the two last censuses. That is the job of the function `rm_dead_twice()`.

```{r}
not_dead_twice <- rm_dead_twice(vft1)
```

`rm_dead_twic()` appends the data with the column `status_dead`.

```{r}
tail(names(not_dead_twice))
```

`rm_dead_twic()` also removes irrelevant censuses. 

```{r}
unique(not_dead_twice$CensusID)
```

Now we are left with data from the last two censuses which is all we need:
* If a tree was alive in the last censuses, we want to re-census it.
* If a tree was alive in the previous last censuses but dead in the last census, we also want to re-census it.
* If a tree was dead in the last two censuses, we consider it dead and we don't want to re-census it.

But still the data has one census too many. We already removed the trees that are "really" dead. So the information of the last census is enough to label a tree as either _alive_ or "possibly" _dead_. So we can further filter the data to keep only the last census.

```{r}
want <- top(not_dead_twice, CensusID, -1)
```

Let's confirm that the data we `want` has only the last census.

```{r}
unique(want$CensusID)
```

Great! This is what the data we `want` looks like.

```{r}
want
```

Notice above that some trees spillover (focus on the first row). Those trees would map beyond the quadrat limits. The problem with that is that the information about the tree status (alive or dead) is given by the symbol that plots at the actual position of each tree. If we cut the map limits at 20m, we won't see the symbols and therefore we won't know the tree status. We can fix that in two (non exclusive) ways.

__1. Label dead trees beyond quadrat edge__

One subtle solution is to suffix dead trees beyond quadrat edge -- specifically. Because this labeling is so specific, the clutter we add to the plot is minimum.

```{r}
suffixed <- suffix_edgy_dead(
  x = want,            # What data?
  status_d = "dead",   # Trees of what status?
  suffix = ".d",       # What suffix to add?
  x_q = 20             # What is the limit beyond which we want to add a suffix?
)
suffixed
```

And now we are ready to map.

```{r}
p <- map_tag(suffixed)
# Showing only one quarter of the entire quadrat.
p[[3]]
```

Notice `Tag = 073246.d` at `QX = 20.20` and `QY = 13.25`: It is beyond the edge and is dead; therefore its tag has the suffix ".d".
Notice `Tag = 073247` at `QX = 20.20` and `QY = 13.60`: It is beyond the edge but is alive; therefore its tag has no suffix.

__2. Show quadrat beyond the edge__

Another way to help solve this problem is to move the quadrat edge a little beyond its limit.

```{r}
p1 <- map_tag(suffixed, move_edge = 1)
# Showing only one quarter of the entire quadrat.
p1[[3]]
```

Now we can see the position of the tree 073246, and therefore we can see the symbol "x" indicating that it is dead.

__Suffix all dead trees__

If you want to suffix all dead trees, simply choose `x_q = 0`.

```{r}
suffix_all <- suffix_edgy_dead(
  x = want,            # What data?
  status_d = "dead",   # Trees of what status?
  suffix = ".d",       # What suffix to add?
  x_q = 0              # What is the limit beyond which we want to add a suffix?
)
```

Now notice that -- regardless of their position --all dead trees have the suffix ".d".

```{r}
filter(suffix_all, Status == "dead")
```

```{r}
map_tag(suffix_all)[[3]]
```

