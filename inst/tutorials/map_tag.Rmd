---
title: "Mapping Latest Tree-Status in Subquadrats"
author: "Mauro Lepore"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 6
vignette: >
  %\VignetteIndexEntry{Mapping Latest Tree Status in Subquadrats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
# hadley's settings
set.seed(1014)
options(digits = 3)

knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)

library(ggplot2)
update_geom_defaults("text", list(size = 14.5))
```

# Overview

This vignette shows you how to map the latest tree-status in subquadrats with `map_tag()`. Those maps are most useful during fieldwork, so the output of `map_tag()` is optimized for printing on paper. Currently, `map_tag()` lives in the __try__ package, but after I receive some feedback I will move it to the __forestr__.

```{r, eval=FALSE, echo=FALSE}
# xxx after receiving feedback,  edit paragraph above.
```

```{r}
# install_github("forestgeo/try@iss1_map_tag")
library(try)

# Also using the package dplyr for easier data manipulation
# install.packages(dplyr)
library(dplyr)
# Print only a few rows of tibbles (modern dataframes) to save space
options(dplyr.print_min = 6, dplyr.print_max = 6)
```

```{r, eval=FALSE, echo=FALSE}
# # xxx When moving to forestr, replace chunk above by this one

# # To install from a private repo, use auth_token with a token from
# # https://github.com/settings/tokens. You only need the repo scope. Best
# # practice is to save your PAT in env var called GITHUB_PAT (see ?Sys.setenv).
# # install_github("forestgeo/forestr")
# library(forestr)
# 
# # Also using the package dplyr for easier data manipulation
# # install.packages(dplyr)
# library(dplyr)
# # Print only a few rows of tibbles (modern dataframes) to save space
# options(dplyr.print_min = 6, dplyr.print_max = 6)
```

Currently, `map_tag()` works with ViewFullTables. Here you will use an example dataset from Barro Colorado Island, that was made public in 2012.

```{r}
# Example data set: A few quadrats of a ViewFullTable from BCI (census 7, made
# public in 2012 via https://repository.si.edu/handle/10088/20925)

# Convert to tibble (modern dataframe) for better printing
vft <- as_tibble(bci12vft_mini)
vft

vft %>% names()
select(vft, 13:19)
```

# Quick Maps: Using Defaults

Some data sets may have unexpected names. If so, changes them.

```{r, error=TRUE}
map_tag(vft, site_name = "BCI 2012")
```

```{r}
# Evaluate names and fix the wrong ones
select(vft, x, y)


names(vft)
vft <- dplyr::rename(vft, qx = x, qy = y)
vft$gx
vft$gx

map_tag(vft, site_name = "BCI 2012")
```

## Mapping Latest Tree Status in Subquadrats


# Customizing Your Maps





Notice that only the first two arguments of these functions are strictly necessary.

```{r}
# Print to screen
map_sp(census, c("hybapr", "faraoc"))
```

```{r}
# Defaults to save in working directory. Returns invisibly.
map_sp_pdf(census, c("hybapr", "faraoc"))
```

```{r fig.align="default", out.width="45%", fig.widh=(6 * 0.45 / 0.7)}
# Force printing the invisible output
print(map_sp_pdf(census, c("hybapr", "faraoc")))

# (Printing side by side to save space)
```

Keep in mind that your census data must have specific variable-names:

```{r, error=TRUE}
# Show behaviour with wrong name
with_wrong_name <- rename(census, SP = sp)

# This will fail because the data set has name `SP`, not `sp`
map_sp(with_wrong_name, c("hybapr", "faraoc"))
```

## Adding Elevation

You may have elevation data from your site.

```{r}
my_elev <- forestr::bci_elevation
my_elev
```

Note that the elevation data set must have very specific variable names; or it will fail:

```{r, error=TRUE}
# This will fail because the names of `my_elev` are not correct
map_sp(census, c("hybapr", "faraoc"), elevation = my_elev)
```

If necessary, rename your variables:

```{r}
# Renaming data and trying again
elev <- rename(my_elev, gx = x, gy = y)
map_sp(census, c("hybapr", "faraoc"), elevation = elev)
```

# Dealing with Overplotting

Sometimes a species is so abundant that its distribution overplots.

```{r}
# Fake over abundant species
crowded <- dplyr::tibble(
  sp = sample(c("species1"), 10000, replace = TRUE),
  gx = sample.int(1000, 10000, replace = TRUE),
  gy = sample.int(500, 10000, replace = TRUE)
)
map_sp(crowded, c("species1"))
```

To reduce overplotting, you can do a number of things. First, you can try reducing the size or opacity of the points, or changing their shape.

```{r fig.align="default", out.width="45%", fig.widh=(6 * 0.45 / 0.7)}
# smaller and semi transparent
map_sp(crowded, c("species1"), size = 1, alpha = 2/10)

# Smaller and open
map_sp(crowded, c("species1"), size = 1, shape = 21)

# (Printing side by side to save space)
```

If your research question allows, you can try subsampling your data.

```{r}
# A random sample of 2000 stems
smaller <- sample_n(crowded, 2000)
map_sp(smaller, c("species1"), shape = 21)
```

# Customizing Your Maps

You may want to customize your maps. For example, you may want to change some properties of the points or elevation lines (e.g. colour); or the general theme of the map. These are relatively common changes.

## Most Common Changes

### Changing Points' Properties

Both `map_sp()` and `map_sp_pdf()` have the argument `...`, which lets you pass arguments to `ggplot2::geom_point()` to change points' properties such as the shape, size, fill, colour, and stroke. Read `?ggplot2::geom_point()` to learn all your options; here you can see some common ones:

```{r}
map_sp(census, "hybapr",
  # Arguments passed to ggplot2::geom_point()
  size = 4, shape = 22, fill = "green", colour = "black", stroke = 2)
```

### Changing Properties of the Elevation Lines

You can also customize the elevation lines. This example shows all the available options:

* Change line size;
* set colours to represent low and high elevation;
* set the number of intervals in which the elevation variable is to be cut (note that the cut results in ugly numbers, with many decimals; also, with increasing bins' number the function takes longer to run).

```{r}
map_sp(census, "hybapr", 
  elevation = elev, line_size = 1, low = "red", high = "blue", bins = 4)
```


### Changing the Theme

You can change the general look of your map by changing its theme. A number of pre-set themes are available in the __ggplot2__ package (see `?ggplot2::theme_bw()`).

```{r, fig.align="default", out.width="45%", fig.widh=(6 * 0.45 / 0.7)}
map_sp(census, "hybapr", theme = ggplot2::theme_classic())
map_sp(census, "hybapr", theme = ggplot2::theme_dark())

# (Printing side by side to save space)
```

## Less Common Changes

Here are some changes that you may need less often but are still good to keep in mind.

### Change File Name

When printing to .pdf, you can provide a custom file name (including the path to a directory); but note the file name must end in _.pdf_ or it will be replaced by a default name:

```{r, error=TRUE}
spp <- c("hybapr", "faraoc")

map_sp_pdf(census, spp, elevation = elev, file = "bad-name1")

map_sp_pdf(census, spp, elevation = elev, file = "bad-name2.png")

```

This is OK. (Note that you can suppress messages)

```{r}
map_sp_pdf(census, spp, elevation = elev, file = "good-name.pdf")

# Same without any message
suppressMessages(
  map_sp_pdf(census, spp, elevation = elev, file = "good-name.pdf")
)
```



### Change x and y Limits

Occasionally you may need to change the map limits. The map limits default to the range 0-max, where max is the maximum value of the variable `gx` or `gy` in the census data. In the unlikely case where no stem occurs at the maximum limits of your plot, the default would result in a map that spans less than the defined limits of the site's plot.

```{r, fig.align="default", out.width="45%", fig.widh=(6 * 0.45 / 0.7)}
# Fake case: The maximum-limits of the site's plot are gx = 1000 and gy = 500;
# but all stems in the census occurr at lower gx and gy limits
odd_data <- filter(census, gx < 800, gy < 200)
two_species <- unique(odd_data$sp)[1:2]
map_sp(odd_data, two_species)

# (Printing side by side to save space)
```

You can overwrite the default limits with the arguments `xlim` and `ylim`:

```{r, fig.align="default", out.width="45%", fig.widh=(6 * 0.45 / 0.7)}
map_sp(odd_data, two_species, xlim = c(0, 1000), ylim = c(0, 500))

# (Printing side by side to save space)
```

# Fine Tunning

This last section shows you how to fine tune your plots. For this, you will need a couple of functions from packages other than __forestr__.

## Multiple Plots in One Page

To plot multiple maps on one page you can use `gridExtra::maparrange()`:

```{r}
library(gridExtra)

all_species <- unique(census$sp)
maps <- map_sp(census, all_species)
multipaged <- marrangeGrob(maps, nrow = 1, ncol = 2)
multipaged
```

The multi-paged maps can also be saved to a .pdf.

```{r}
# Saving to .pdf: Option 1
ggplot2::ggsave("multi-paged.pdf", multipaged)

# Saving to .pdf: Option 2
pdf()
multipaged
dev.off()
```

It is also possible to save the multi-paged maps to devices other than .pdf -- the png() device, for example, will automatically create one file per page.

```{r}
# Saving to .png; this will create multiple files.
png()
multipaged
dev.off()
```

## Customizing the Theme

Before, you used a pre-made theme. But you can create your own theme with `ggplot2::theme()`, save it as an object, and pass that object to `map_sp()` or `map_sp_pdf()`. 

```{r}
# Showing only a few options; see all the options with ?ggplot2::theme()
my_theme <- ggplot2::theme(
  text = element_text(size = 25, face = "bold.italic", colour = "white"),
  plot.background = element_rect(fill = "black"),
  plot.margin = margin(2, 2, 2, 2, "cm"),
  strip.background = element_rect(fill = "darkgreen"),
  strip.text = element_text(colour = "white"),
  # make grid to dissapear by matching background colour
  panel.background = element_rect(fill = "lightgreen"),
  panel.grid.minor = element_line(colour = "lightgreen"),
  panel.grid.major = element_line(colour = "lightgreen")
)
map_sp(census, "hybapr", theme = my_theme)
```

## Extending with ggplot2

Finally, you can also use the output of `map_sp()` and `map_pdf()` as the starting point for further customization with __ggplot2__ (the next section provides resources to learn __ggplot2__). That may be convenient for minor extensions; for larger ones you may prefer to start from scratch. Note that `map_sp()` and `map_sp_pdf()` output not just one plot but a list of plots. That is important to keep in mind if you want to iterate over all the plot-elements of the output list. For example, this is how you would add a new layer to one element of the plots' list:

```{r}
p0 <- map_sp(census, c("hybapr", "faraoc"))

# Adding a new layer to one element of the plots' list
p0[["hybapr"]] + geom_vline(aes(xintercept = 300), colour = "red")
```

And this is how you can apply new layers to all the plot-elements of a list (note that the function `+` is applied to each item of the plots' list):

```{r fig.align="default", out.width="45%", fig.widh=(6 * 0.45 / 0.7)}
p1 <- lapply(p0, `+`, geom_vline(aes(xintercept = 300), colour = "red"))
p1

p2 <- lapply(p1, `+`, geom_hline(aes(yintercept = 400), colour = "blue"))
p2

# (Printing side by side to save space)
```

## Learning More

There are many visualization systems in R. The system built in `map_sp()` and `map_sp_pdf()` is that of the __ggplot2__ package. __ggplot2__ is not an arbitrary collection of functions; it is one implementation of [The Grammar of Graphics](https://goo.gl/E514ar). Good places to learn __ggplot2__ include [this website](https://goo.gl/tVvLQZ); this specialized, paid book: [ggplot2: Elegant Graphics for Data Analysis](https://goo.gl/R6wJk9); and this general, free book [R for Data Science](http://r4ds.had.co.nz/).
