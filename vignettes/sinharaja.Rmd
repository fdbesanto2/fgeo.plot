---
title: "Plot Repulsive Tags from Sinharaha"
author: "Mauro Lepore"
date: "2017-09-26"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 6
vignette: >
  %\VignetteIndexEntry{Plot repulsive tags from Sinharaha}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
# hadley's settings
set.seed(1014)
options(digits = 3)

knitr::opts_chunk$set(
  echo = TRUE,  # {mine}
  comment = "#>",
  collapse = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold"
)

options(dplyr.print_min = 6, dplyr.print_max = 6)
```

# First attempt

This code was originally used to output the maps that were first printed.

```
# The sinharaja package is local and the data set sinh_q20 is private.
list_of_dataframes <- sinharaja::sinh_q20

# Filder selected quadrats
path <- "../sinharaja/data-raw/from_shameema/"
file_nm <- "Quadrat abundances 2017.to_check.xlsx"
selected_quads <- readxl::read_xlsx(paste0(path, file_nm)) %>%
  select(Quad_Name, QuadCheck) %>%
  filter(QuadCheck %in% c(1.5, 2)) %>%
  unique() %>%
  pull(Quad_Name)
selected_list_of_dataframes <- list_of_dataframes[selected_quads]
# Confirm
identical(selected_quads, names(selected_list_of_dataframes))

# Prepare and pdf
prepared <- prep_repulsive_tags(selected_list_of_dataframes)
plot_list <- lapply_plot_repulsive_tags(prepared, site_name = "Sinharaja 2017")

pdf(onefile = TRUE, paper = "a4", width = 11, height = 11)
plot_list
dev.off()
```

# Setup 

```{r}
library(tidyverse)
library(try)
```



# Second attempt

## Merge ViewFullTable with Shameema's list of dataframes

* ViewFullTable has the correct information of the subquadrat where each tree should be.
* Shameema's list of dataframes has the data on symbol and status

Import data.

```{r}
vftbl <- sinharaja::sinh_vftbl_selected
vftbl
```

Raname data to match the needs of existing functions.

```{r}
n_original <- nrow(vftbl)

renamed <- vftbl %>% 
  select(-id, -StemTag, -Status) %>% 
  rename(
    tag = Tag,
    subquadrat_vftbl = Subquadrat,
    quadrat_vftbl = QuadratName,
    lx = QX,
    ly = QY
  ) %>% 
  unique()
renamed
```

Get symbols from Shameema's list of dataframes

```{r}
sham_df <- sinharaja::sinh_q20 %>% 
  reduce(full_join) %>% 
  as_tibble()
# allow merging by tag
sham_df <- sham_df %>% 
  mutate(
    status = as.character(status),
    tag = str_pad(tag, width = 6, side = "left", pad = "0")
  ) %>% 
  select(-lx, -ly, -subtag) %>% 
  unique()
sham_df
```

Merge selected data (quadrats chosen by Stuart) from ViewFullTable with status and symbols by Shameema

```{r}
sinh_df <- left_join(renamed, sham_df)
sinh_df
```

Split the data

```{r}
splitted <- sinh_df %>% split(.$quadrat_vftbl)
splitted[[1]] %>% unique()
```

## Prepare and plot

```{r}
# Prepare and pdf
prepared <- prep_repulsive_tags(splitted)[4]
plot_list <- lapply_plot_repulsive_tags(prepared, site_name = "Sinharaja 2017")

pdf(onefile = TRUE, paper = "a4", width = 11, height = 11)
plot_list
dev.off()
```



