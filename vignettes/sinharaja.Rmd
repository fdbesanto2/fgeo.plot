---
title: "Plot Repulsive Tags from Sinharaha"
author: "Mauro Lepore"
date: "2017-09-26"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 6
vignette: >
  %\VignetteIndexEntry{Plot repulsive tags from Sinharaha}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
# hadley's settings
set.seed(1014)
options(digits = 3)

knitr::opts_chunk$set(
  echo = TRUE,  # {mine}
  comment = "#>",
  collapse = TRUE,
  # cache = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.asp = 0.618,  # 1 / phi
  fig.show = "hold",
  rows.print = 3  # {mine}
)

options(dplyr.print_min = 3, dplyr.print_max = 3)
```

# First attempt

This code was originally used to output the maps that were first printed.

```
# The sinharaja package is local and the data set sinh_q20 is private.
list_of_dataframes <- sinharaja::sinh_q20

# Filder selected quadrats
path <- "../sinharaja/data-raw/from_shameema/"
file_nm <- "Quadrat abundances 2017.to_check.xlsx"
selected_quads <- readxl::read_xlsx(paste0(path, file_nm)) %>%
  select(Quad_Name, QuadCheck) %>%
  filter(QuadCheck %in% c(1.5, 2)) %>%
  unique() %>%
  pull(Quad_Name)
selected_list_of_dataframes <- list_of_dataframes[selected_quads]
# Confirm
identical(selected_quads, names(selected_list_of_dataframes))

# Prepare and pdf
prepared <- prep_repulsive_tags(selected_list_of_dataframes)
plot_list <- lapply_plot_repulsive_tags(prepared, site_name = "Sinharaja 2017")

pdf(onefile = TRUE, paper = "a4", width = 11, height = 11)
plot_list
dev.off()
```

# Setup 

```{r}
library(tidyverse)
library(try)
```



# Second attempt

Here I use subquadrat information 

From ViewFullTable, here I get information for each tree including its subquadrat, and position. ViewFullTable  also has information on tree status, which I could use directly to plot the latest status of each tree. This seems to be exactly what a general function should do. For that, the code below should be adapted to use the ViewFullTable specifically.

This vignette, however, shows a special case. Here, the tree status that I am plotting comes not from ViewFullTable but from data that Shameema provided. Those data from Shameema contain a particular status that Stuart wants to recheck. That status Shameema represented with some symbols. I am unsure how Shameema calculated that status because it does not match the ViewFullTable directly. This  is  something I asked Shameema (via https://goo.gl/NzoxqY), but as per Nov 4th, 2017, she didn't reply.

## Merge ViewFullTable with Shameema's list of dataframes

* ViewFullTable has the correct information of the subquadrat where each tree should be. 

(The Subquadrat variable was calculated by Anudeep. This is what I am using here, but I translated Anudeep's SQL-code to R-code (see `?add_subquadrat()` and https://goo.gl/J4KVU1).)

* Shameema's list of dataframes has the data on symbol and status

Import data.

```{r}
vftbl <- sinharaja::sinh_vftbl_selected
vftbl
```

```{r}
nrow(vftbl)
```

Raname data to match the needs of existing functions.

```{r}
renamed <- vftbl %>% 
  select(-id, -StemTag, -Status) %>% 
  rename(
    tag = Tag,
    subquadrat_vftbl = Subquadrat,
    quadrat_vftbl = QuadratName,
    lx = QX,
    ly = QY
  ) %>% 
  unique()
renamed
```

Get symbols from Shameema's list of dataframes

```{r, message=FALSE}
sham_df <- sinharaja::sinh_q20 %>% 
  reduce(full_join) %>% 
  as_tibble()
# allow merging by tag
sham_df <- sham_df %>% 
  mutate(
    status = as.character(status),
    tag = str_pad(tag, width = 6, side = "left", pad = "0")
  ) %>% 
  select(-lx, -ly, -subtag) %>% 
  unique()
sham_df
```

Merge selected data (quadrats chosen by Stuart) from ViewFullTable with status and symbols by Shameema

```{r}
sinh_df <- suppressMessages(left_join(renamed, sham_df))
sinh_df
```

Split the data

```{r}
splitted <- sinh_df %>% split(.$quadrat_vftbl)
# example
splitted[["0015"]]
```

Table problematic trees

```{r}
problematic <- splitted %>% 
  map(as.data.frame) %>% 
  map(filter, lx >= 20 | ly >= 20) %>% 
  map(arrange, tag) %>% 
  map(select, tag, subquadrat_vftbl)
# e.g.
problematic[["0015"]]
```



## Prepare and plot


```{r, message=FALSE}
prep_list <- splitted %>% prep_repulsive_tags()
plot_list <- prep_list %>% 
  lapply_plot_repulsive_tags(site_name = "Sinharaja 2017")

# # Avoid running unintentionally; it takes a few minutes to run
# pdf(onefile = TRUE, paper = "a4", width = 11, height = 11)
# plot_list
# dev.off()
```



Just two extreeme quadrats.

```{r, message=FALSE}
df <- splitted %>% reduce(full_join)
extreeme_quadrats <- df %>% 
  filter(lx == max(lx) | ly == max(ly)) %>%
  pull(quadrat_vftbl)
extreeme_quadrats
```


```{r, message=FALSE}
# dataframe and filter easyly by quadrat
prep_df <- prep_list %>% reduce(full_join)
prep_df_extreeme <- prep_df %>% 
  filter(quadrat %in% extreeme_quadrats)

# Split by id
prep_list_extreeme <- split(prep_df_extreeme, prep_df_extreeme$id)
plot_list_extreeme <- lapply_plot_repulsive_tags(
  prep_list_extreeme, site_name = "Sinharaja 2017"
)

pdf("extreeme.pdf", paper = "a4", width = 11, height = 11)
plot_list_extreeme
dev.off()
```





